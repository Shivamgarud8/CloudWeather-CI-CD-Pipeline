pipeline {
    agent any

    environment {
        SSH_CRED    = 'node-cred'  // Jenkins SSH credential ID
        SERVER_IP   = '13.53.216.159'
        REMOTE_USER = 'ubuntu'
        APP_DIR     = '/home/ubuntu/weather-notify-telegram'
        REPO_URL    = 'https://github.com/Shivamgarud8/weather-notify-telegram.git'

        # Environment variables for your app
        OPENWEATHER_API_KEY = '803f77a96502ec00149f4b07055e5dd5'
        TELEGRAM_BOT_TOKEN  = '8542334853:AAF0fE6Otml0RVEIsDGPvdDUBBrE15sad78'
        TELEGRAM_CHAT_ID    = '1773222136'
    }

    stages {

        stage('Clone Repository') {
            steps {
                echo 'üì¶ Cloning repository...'
                git url: "${REPO_URL}", branch: 'main'
            }
        }

        stage('Transfer Files to Server') {
            steps {
                echo 'üöÄ Copying project files to remote server...'
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "
                            sudo mkdir -p ${APP_DIR} &&
                            sudo chown -R ${REMOTE_USER}:${REMOTE_USER} ${APP_DIR}
                        "
                        scp -o StrictHostKeyChecking=no -r * ${REMOTE_USER}@${SERVER_IP}:${APP_DIR}/
                    '''
                }
            }
        }

        stage('Setup Python Environment') {
            steps {
                echo 'üêç Installing Python and dependencies...'
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "
                            sudo apt update -y &&
                            sudo apt install -y python3 python3-pip python3-venv git &&
                            cd ${APP_DIR} &&
                            python3 -m venv venv ||
                            (sudo apt install -y python3.12-venv && python3 -m venv venv) &&

                            source venv/bin/activate &&
                            pip install --upgrade pip &&
                            if [ -f 'requirements.txt' ]; then
                                pip install -r requirements.txt
                            else
                                pip install requests flask
                            fi
                        "
                    '''
                }
            }
        }

        stage('Run Weather Script') {
            steps {
                echo 'üå¶Ô∏è Running weather Telegram notifier...'
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "
                            cd ${APP_DIR} &&
                            source venv/bin/activate &&

                            export OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY} &&
                            export TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN} &&
                            export TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID} &&

                            # Kill old process if already running
                            fuser -k 5000/tcp || true &&
                            pkill -f app.py || true &&

                            # Run new instance in background
                            nohup venv/bin/python3 app.py > app.log 2>&1 &

                            echo '‚úÖ Weather notifier is running successfully!'
                        "
                    '''
                }
            }
        }

        stage('Verify Process') {
            steps {
                echo 'üîç Checking running status on server...'
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "
                            ps aux | grep app.py | grep -v grep || echo '‚ùå app.py not running!'
                            tail -n 10 ${APP_DIR}/app.log || echo '‚ö†Ô∏è No logs found!'
                        "
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'üéâ Weather Notification Bot deployed successfully!'
        }
        failure {
            echo '‚ùå Deployment failed. Check Jenkins logs or app.log on the server.'
        }
    }
}
