pipeline {
    agent any

    environment {
        SSH_CRED    = 'node-cred'  // Jenkins SSH credential ID
        SERVER_IP   = '13.53.75.72'
        REMOTE_USER = 'ubuntu'
        APP_DIR     = '/home/ubuntu/weather-app'
        REPO_URL    = 'https://github.com/Shivamgarud8/weather-jenkins-python-pipeline.git'
    }

    stages {

        stage('Clone Repository') {
            steps {
                echo 'ğŸ“¦ Cloning repository...'
                git url: "${REPO_URL}", branch: 'main'
            }
        }

        stage('Setup Server & Transfer Files') {
            steps {
                echo 'ğŸš€ Setting up remote server and transferring files...'
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "
                            sudo mkdir -p ${APP_DIR} &&
                            sudo chown -R ${REMOTE_USER}:${REMOTE_USER} ${APP_DIR}
                        "
                        scp -o StrictHostKeyChecking=no -r app.py requirements.txt templates ${REMOTE_USER}@${SERVER_IP}:${APP_DIR}/
                    '''
                }
            }
        }

        stage('Install Python & Setup Environment') {
            steps {
                echo 'âš™ï¸ Installing Python, pip, and venv on remote server...'
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "
                            sudo apt update -y &&
                            sudo apt install -y python3 python3-pip python3-venv git &&
                            python3 -m venv ${APP_DIR}/venv ||
                            (sudo apt install -y python3.12-venv && python3 -m venv ${APP_DIR}/venv)
                        "
                    '''
                }
            }
        }

        stage('Install Dependencies & Run Flask App') {
            steps {
                echo 'ğŸ“¦ Installing dependencies and running Flask app...'
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "
                            cd ${APP_DIR} &&
                            source venv/bin/activate &&
                            pip install --upgrade pip &&
                            if [ -f 'requirements.txt' ]; then
                                pip install -r requirements.txt
                            else
                                pip install requests==2.31.0 flask
                            fi &&

                            # Kill old process if running
                            fuser -k 5000/tcp || true &&

                            # Run Flask app in background
                            nohup venv/bin/python3 app.py > app.log 2>&1 &

                            echo 'âœ… Flask app deployed successfully and running on port 5000!'
                        "
                    '''
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                echo 'ğŸ” Verifying Flask app status...'
                sshagent(credentials: ["${SSH_CRED}"]) {
                    sh '''
                        ssh -o StrictHostKeyChecking=no ${REMOTE_USER}@${SERVER_IP} "
                            echo 'ğŸ©º Checking running process...'
                            ps aux | grep app.py | grep -v grep || echo 'âŒ Flask app not running!'

                            echo 'ğŸŒ Checking port 5000...'
                            sudo netstat -tuln | grep 5000 || echo 'âŒ Port 5000 not listening!'
                        "
                    '''
                }
            }
        }
    }

    post {
        success {
            echo 'ğŸ‰ Deployment successful! Visit http://${SERVER_IP}:5000 to access your app.'
        }
        failure {
            echo 'âŒ Deployment failed. Check Jenkins logs and /home/ubuntu/weather-app/app.log on the server.'
        }
    }
}
